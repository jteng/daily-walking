<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>每天与主同行</title>
    <!-- versioned manifest to bust cache when we update the app -->
    <link rel="manifest" href="manifest.json?v=3">
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <link rel="icon" href="./icons/icon-192.png" sizes="192x192" />
    <link rel="icon" href="./icons/icon-512.png" sizes="512x512" />
    <link rel="mask-icon" href="./icons/icon.svg" color="#4A90E2">
    
    <style>
        :root { --primary: #4A90E2; --bg: #f5f7fa; --text: #333; }
        body { font-family: -apple-system, "PingFang SC", "Helvetica Neue", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        header { background: var(--primary); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; line-height: 1.8; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .scripture-ref { font-weight: bold; color: var(--primary); font-size: 1.1em; display: block; margin-bottom: 10px; }
        h2 { margin: 0 0 15px 0; font-size: 1.4em; }
        .section-title { font-weight: bold; border-left: 4px solid var(--primary); padding-left: 10px; margin: 25px 0 10px 0; }
        .verse-box { background: #eef5ff; border-radius: 8px; padding: 15px; font-style: italic; color: #444; margin-top: 20px; border: 1px dashed var(--primary); }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        button { border: none; background: var(--primary); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; cursor: pointer; transition: opacity 0.2s; }
        button:disabled { background: #ccc; }
        .day-indicator { color: var(--text); line-height: 36px; font-weight: bold; }
        .commentary-box {
            background-color: #f9fafb;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            font-size: 0.95em;
            color: #444;
        }
        .commentary-box h5 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: var(--primary);
        }
        /* Table styling for extracted tables inserted into content */
        #devotional-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            table-layout: auto;
            font-size: 0.95em;
        }
        #devotional-content th,
        #devotional-content td {
            border: 1px solid #e0e6ef;
            padding: 8px 10px;
            vertical-align: top;
        }
        #devotional-content thead th {
            background: #f7f9fc;
            color: var(--text);
            font-weight: 600;
        }
        /* small responsive tweak for very small screens */
        @media (max-width: 420px) {
            #devotional-content th, #devotional-content td { padding: 6px; font-size: 0.9em; }
        }
    </style>
</head>
<body>

<header>
    <div id="date-display" style="font-size: 0.8em; opacity: 0.8;">第一周</div>
    <h1 id="app-title"   style="margin: 5px 0; font-size: 1.2em;">每天与主同行</h1>
    <div style="margin-top:8px; display:flex; justify-content:center; gap:8px; align-items:center;">
        <select id="jump-week" aria-label="选择周" style="padding:6px 8px; border-radius:6px; border: 1px solid #ddd; background: white; font-size: 14px;">
            <!-- Populated dynamically -->
        </select>
        <select id="jump-day" aria-label="选择日" style="padding:6px 8px; border-radius:6px; border: 1px solid #ddd; background: white; font-size: 14px;">
            <option value="1">第1日</option>
            <option value="2">第2日</option>
            <option value="3">第3日</option>
            <option value="4">第4日</option>
            <option value="5">第5日</option>
            <option value="6">第6日</option>
        </select>
        <button id="jump-btn" style="padding:6px 10px; border-radius:6px;">跳转</button>
    </div>
</header>

<div class="container">
    <div class="card" id="content-card">
        <span class="scripture-ref" id="scripture"></span>
        <h2 id="day-title">载入中...</h2>
        <div id="devotional-content"></div>
        

        
        <div class="verse-box">
            <strong>今日金句：</strong><br>
            <span id="key-verse"></span>
        </div>
    </div>
</div>

    <div class="nav-bar">
    <button onclick="changeDay(-1)" id="prev-btn">前一天</button>
    <div class="day-indicator" id="day-num">
        <div id="day-num-text">第 1 天</div>
        <div id="day-date" style="font-size:0.8em; opacity:0.9;">一月一日</div>
    </div>
    <button onclick="changeDay(1)" id="next-btn">后一天</button>
</div>

<footer style="text-align: center; padding: 20px 20px 100px 20px; color: #666; font-size: 0.85em; line-height: 1.6;">
    内容来源：《每天与主同行》· 苏颖智 著
</footer>

<script>
    // Load data from bibleData.json (generated by extractor). Falls back to a
    // friendly message if the file is missing or parsing fails.
    let bibleData = [];
    // Default current day is day 1 for fresh users (index 0). A saved value
    // in localStorage overrides this. (Previously we computed a default from
    // Jan 1 of the current year; keep that helper for advanced uses.)
    function computeDefaultDayIndex() {
        const now = new Date();
        // Jan 1 of current year
        const start = new Date(now.getFullYear(), 0, 1);
        const msPerDay = 24 * 60 * 60 * 1000;
        const diff = Math.floor((now.setHours(0,0,0,0) - start.setHours(0,0,0,0)) / msPerDay);
        return diff >= 0 ? diff : 0;
    }
    const saved = localStorage.getItem('savedDay');
    let currentDayIndex;
    if (saved !== null) {
        currentDayIndex = parseInt(saved, 10);
    } else {
        // New users start at day 1 (index 0). If you want the old behavior
        // (default based on Jan 1), replace the following line with
        // computeDefaultDayIndex().
        currentDayIndex = 0;
    }

    // Get or set the start date for the reading plan
    // First-time visitors: current date becomes Day 1 Week 1
    function getStartDate() {
        let startDateStr = localStorage.getItem('readingPlanStartDate');
        if (!startDateStr) {
            // First time visitor - use today as Day 1
            const today = new Date();
            startDateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            localStorage.setItem('readingPlanStartDate', startDateStr);
        }
        const [year, month, day] = startDateStr.split('-').map(Number);
        return new Date(year, month - 1, day);
    }

    const PLAN_START_DATE = getStartDate();

    // helpers to render Chinese month/day like "一月一日"
    const CN_DIGITS = ['零','一','二','三','四','五','六','七','八','九'];
    function numToChinese(n){
        if(n <= 10) return n === 10 ? '十' : CN_DIGITS[n];
        if(n < 20) return '十' + (n % 10 === 0 ? '' : CN_DIGITS[n % 10]);
        const tens = Math.floor(n / 10);
        const ones = n % 10;
        return CN_DIGITS[tens] + '十' + (ones === 0 ? '' : CN_DIGITS[ones]);
    }
    function chineseMonthDayFromIndex(dayIndex){
        // For 6-day plan: every 7th calendar day is a rest day
        // Data index 0 = start date, 1 = start+1 day, ..., 5 = start+5 days, 6 = start+7 days (skip day 6), etc.
        // Formula: calendarDay = dayIndex + floor(dayIndex / 6)
        const d = new Date(PLAN_START_DATE.getTime());
        const calendarOffset = dayIndex + Math.floor(dayIndex / 6);
        d.setDate(d.getDate() + calendarOffset);
        const month = d.getMonth() + 1;
        const day = d.getDate();
        return `${numToChinese(month)}月${numToChinese(day)}日`;
    }

    // DOM helpers to avoid runtime errors when an element is missing
    function el(id){ return document.getElementById(id); }
    function setText(id, txt){ const e = el(id); if(e) e.innerText = txt; else console.warn('Missing element:', id); }
    function setHTML(id, html){ const e = el(id); if(e) e.innerHTML = html; else console.warn('Missing element:', id); }
    function setDisabled(id, v){ const e = el(id); if(e) e.disabled = v; else console.warn('Missing element:', id); }


    // Populate week dropdown based on data length
    function populateWeekDropdown() {
        const weekSelect = document.getElementById('jump-week');
        if (!weekSelect || !bibleData || bibleData.length === 0) return;
        
        const totalWeeks = Math.ceil(bibleData.length / 6);
        weekSelect.innerHTML = '';
        
        for (let i = 1; i <= totalWeeks; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `第${i}周`;
            weekSelect.appendChild(option);
        }
    }

    // Update selects to match current day
    function setJumpSelectsToCurrent() {
        const week = Math.floor(currentDayIndex / 6) + 1;
        const day = (currentDayIndex % 6) + 1;
        
        const weekEl = document.getElementById('jump-week');
        const dayEl = document.getElementById('jump-day');
        
        if (weekEl) weekEl.value = week;
        if (dayEl) dayEl.value = day;
    }

    // Jump handler: read week/day selects and navigate
    function handleJump() {
        const weekEl = document.getElementById('jump-week');
        const dayEl = document.getElementById('jump-day');
        
        if (!weekEl || !dayEl) return;
        
        const week = parseInt(weekEl.value, 10);
        const day = parseInt(dayEl.value, 10);
        
        if (isNaN(week) || isNaN(day)) return;
        
        // Convert week/day to index: (week-1)*6 + (day-1)
        let idx = (week - 1) * 6 + (day - 1);
        
        // Clamp to available data
        if (Array.isArray(bibleData) && bibleData.length > 0) {
            if (idx < 0) idx = 0;
            if (idx >= bibleData.length) idx = bibleData.length - 1;
        }
        
        currentDayIndex = idx;
        localStorage.setItem('savedDay', currentDayIndex);
        renderDay();
    }

    // Wire up jump controls after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        const jb = document.getElementById('jump-btn');
        const jw = document.getElementById('jump-week');
        const jd = document.getElementById('jump-day');
        
        if (jb) jb.addEventListener('click', handleJump);
        if (jw) jw.addEventListener('change', handleJump);
        if (jd) jd.addEventListener('change', handleJump);
    });

    function renderDay() {
        try {
        if (!bibleData || bibleData.length === 0) {
            setText('day-title', '未找到数据');
            setText('devotional-content', '请先运行提取器生成 bibleData.json，然后刷新页面。');

            setText('scripture', '');
            setText('key-verse', '');
            setDisabled('prev-btn', true);
            setDisabled('next-btn', true);
            return;
        }

        // clamp index
        if (currentDayIndex < 0) currentDayIndex = 0;
        if (currentDayIndex >= bibleData.length) currentDayIndex = bibleData.length - 1;

        const data = bibleData[currentDayIndex];
        // day label
        const dayLabel = `第 ${data.day || (currentDayIndex+1)} 天`;
        const dayDateLabel = chineseMonthDayFromIndex(currentDayIndex);
        setText('day-num-text', dayLabel);
        setText('day-date', dayDateLabel);
        // Show week number from data if available, fallback to index calc (legacy behavior)
        let weekNum = data.week;
        if (!weekNum) {
             weekNum = Math.floor(currentDayIndex / 7) + 1;
        }
        setText('date-display', `第 ${weekNum} 周`);
        setText('scripture', data.scripture || '');
        setText('day-title', data.title || '');

        // allow HTML in content if present (tables), otherwise plain text
        const contentEl = el('devotional-content');
        if (contentEl) {
            if (data.content && /\<\/?(table|tr|td|th|div|p)/i.test(data.content)) {
                contentEl.innerHTML = data.content;
            } else {
                contentEl.innerText = data.content || '';
            }
        } else {
            console.warn('Missing element: devotional-content');
        }

        // Display verse text if available, otherwise just show the reference
        const verseEl = el('key-verse');
        if (verseEl) {
            if (data.verse_parts && data.verse_parts.length > 0) {
                // Display each verse part with its individual reference
                const partsHtml = data.verse_parts.map(part => 
                    `<div style="margin-bottom: 12px;"><strong>${part.reference}</strong><br>${part.text}</div>`
                ).join('');
                verseEl.innerHTML = partsHtml;
            } else if (data.verse_text) {
                verseEl.innerText = `${data.verse}\n\n${data.verse_text}`;
            } else {
                verseEl.innerText = data.verse || '';
            }
        }

        setDisabled('prev-btn', currentDayIndex === 0);
        setDisabled('next-btn', currentDayIndex === bibleData.length - 1);
        } catch (err) {
            console.error('renderDay failed:', err);
            // diagnostic: list key elements and their presence
            const ids = ['date-display','day-num-text','day-date','scripture','day-title','devotional-content','reflection','key-verse','prev-btn','next-btn'];
            ids.forEach(id => console.warn(id, !!document.getElementById(id)));
        }

        localStorage.setItem('savedDay', currentDayIndex);
        window.scrollTo(0,0);
        // Keep the week/day selects in sync with the currently shown day
        setJumpSelectsToCurrent();
    }

    function changeDay(step) {
        // For 6-day reading plan: data indices are continuous (0,1,2,3,4,5,6,7...)
        // but calendar dates skip every 7th day (Jan 1,2,3,4,5,6,8,9,10,11,12,13,15...)
        // So we just increment/decrement the data index normally
        currentDayIndex += step;
        renderDay();
    }

    // Fetch bibleData.json from the same directory
    fetch('bibleData.json', { cache: 'no-store' })
        .then(r => {
            if (!r.ok) throw new Error('网络错误：' + r.status);
            return r.json();
        })
        .then(json => {
            // some extractors put the days array at the top-level; accept either
            // an array or an object with a top-level array.
            if (Array.isArray(json)) bibleData = json;
            else if (Array.isArray(json.data)) bibleData = json.data;
            else bibleData = json;
            
            populateWeekDropdown();
            renderDay();
        })
        .catch(err => {
            console.warn('无法加载 bibleData.json:', err);
            bibleData = [];
            renderDay();
        });

    // 注册 Service Worker
    if ('serviceWorker' in navigator) {
        // version string appended to service worker URL to force reload when we change the file
        const APP_SW_VERSION = 'v9';
        window.addEventListener('load', () => {
            navigator.serviceWorker.register(`sw.js?${APP_SW_VERSION}`)
              .then(reg => console.log('sw registered:', reg.scope))
              .catch(err => console.warn('sw registration failed:', err));
        });
    }
</script>
</body>
</html>