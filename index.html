<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊØèÂ§©‰∏é‰∏ªÂêåË°å</title>
    <!-- versioned manifest to bust cache when we update the app -->
    <link rel="manifest" href="manifest.json?v=3">
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <link rel="icon" href="./icons/icon-192.png" sizes="192x192" />
    <link rel="icon" href="./icons/icon-512.png" sizes="512x512" />
    <link rel="mask-icon" href="./icons/icon.svg" color="#4A90E2">
    
    <style>
        :root { --primary: #4A90E2; --bg: #f5f7fa; --text: #333; }
        body { font-family: -apple-system, "PingFang SC", "Helvetica Neue", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        header { background: var(--primary); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        :root {
            --primary: #2c9aff;
            --text: #333;
            --bg: #f5f5f7;
            --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        * { box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        
        /* Reader UI */
        .reader-container {
            width: 100%;
            overflow: hidden; /* Hide the other panel */
            position: relative;
        }
        
        .reader-track {
            display: flex;
            width: 200%; /* Two panels wide */
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: translateX(0); /* Start at Bible Panel (0) or Devotional (-50%)? */
            /* We want Bible First (0%), then Devotional (-50%) */
        }
        
        .reader-panel {
            width: 50%;
            flex-shrink: 0;
            padding: 20px;
            /* Allow individual panels to handle their content flow */
        }

        /* Classic Mode overrides */
        .mode-classic .reader-track {
            display: block;
            width: 100%;
            transform: none !important; 
        }
        .mode-classic #bible-panel {
            display: none;
        }
        .mode-classic #devotional-panel {
            width: 100%;
            display: block;
            padding: 10px;
        }
        .mode-classic .reader-nav {
            display: none;
        }

        .panel-content {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-height: 80vh; /* Visual consistency */
        }

        .container {
            /* Legacy container style if needed, but we override padding on panel */
            max-width: 100%; 
            margin: 0;
            padding: 0;
        }

        /* header style removed to use the one defined at top */
        
        /* Navigation Dots */
        .reader-nav {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 10px 0;
            background: transparent;
        }
        .nav-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
            transition: background 0.3s;
            cursor: pointer;
        }
        .nav-dot.active {
            background: var(--primary);
        }

        /* Existing Styles adapted */
        #content {
            /* No longer used as main wrapper, but might still target id */
            margin-top: 0; 
        }

        #scripture-ref {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        h2 { margin-top: 0; }
        
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: opacity 0.2s;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        button:hover:not(:disabled) {
            opacity: 0.9;
        }

        /* Bible Text Styles */
        #full-scripture-content {
            font-size: 1.1em;
            line-height: 1.8;
        }
        
        /* Devotional Content Styles - Match Bible Text */
        #devotional-content {
            font-size: 1.1em;
            line-height: 1.8;
        }
        
        .bible-chapter {
            margin-bottom: 24px;
        }
        .bible-chapter h3 {
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .bible-verse {
            margin-bottom: 4px;
        }
        .verse-num {
            font-size: 0.8em;
            color: #999;
            vertical-align: super;
            margin-right: 4px;
        }

        /* Tooltip Styles (Keep transparent/overlay) */
        .verse-tooltip {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 300px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .reader-panel { padding: 10px; }
            .panel-content { padding: 16px; }
            
            /* Mobile tooltip refinements */
            .verse-tooltip {
                max-width: 90vw !important;
                width: max-content; /* Shrink to fit content */
                /* Remove forced centering hacks, let JS position it */
                transform: none !important;
                left: auto !important; 
                pointer-events: auto; /* Allow clicking inside? */
            }
        }
        
        .verse-tooltip.show {
            opacity: 1;
        }
        
        .verse-tooltip-ref {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
            display: block;
            font-size: 0.95em;
            pointer-events: none;
        }
        
        .verse-tooltip * {
            pointer-events: none;
        }
        /* Existing styles that are still relevant or not fully overridden */
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .scripture-ref { font-weight: bold; color: var(--primary); font-size: 1.1em; display: block; margin-bottom: 10px; }
        h2 { margin: 0 0 15px 0; font-size: 1.4em; }
        .section-title { font-weight: bold; border-left: 4px solid var(--primary); padding-left: 10px; margin: 25px 0 10px 0; }
        .verse-box { background: #eef5ff; border-radius: 8px; padding: 15px; font-style: italic; color: #444; margin-top: 20px; border: 1px dashed var(--primary); }
        .commentary-box {
            background-color: #f9fafb;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            font-size: 0.95em;
            color: #444;
        }
        .commentary-box h5 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: var(--primary);
        }
        /* Table styling for extracted tables inserted into content */
        #devotional-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            table-layout: auto;
            font-size: 0.95em;
        }
        #devotional-content th,
        #devotional-content td {
            border: 1px solid #e0e6ef;
            padding: 8px 10px;
            vertical-align: top;
        }
        #devotional-content thead th {
            background: #f7f9fc;
            color: var(--text);
            font-weight: 600;
        }
        /* small responsive tweak for very small screens */
        @media (max-width: 420px) {
            #devotional-content th, #devotional-content td { padding: 6px; font-size: 0.9em; }
        }
        
        /* Verse reference hover styles */
        .verse-ref {
            cursor: help;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-decoration-color: var(--primary);
            color: inherit;
            position: relative;
        }
        
    </style>
</head>
<body>

<header>
    <h1 id="app-title" style="margin: 5px 0; font-size: 1.2em;">ÊØèÂ§©‰∏é‰∏ªÂêåË°å</h1>
    <div style="margin-top:8px; display:flex; justify-content:center; gap:8px; align-items:center;">
        <!-- Chapter selector -->
        <select id="jump-chapter" aria-label="ÈÄâÊã©Á´†ËäÇ" style="padding:6px 8px; border-radius:6px; border:1px solid #ddd; background:white; font-size:14px; min-width:160px;">
            <option value="">ÈÄâÊã©Á´†ËäÇ...</option>
            <!-- Populated dynamically -->
        </select>
        
        <!-- Mode Toggle -->
        <button id="mode-toggle" onclick="Reader.toggleMode()" style="padding: 6px 12px; font-size: 14px; background: white; color: var(--primary); border: 1px solid white;">üìñ</button>
    </div>
    <div id="week-day-info" style="font-size:12px; color:#666; margin-top:4px;"></div>
    
    <!-- Reader Navigation Dots (outside panels) -->
    <div class="reader-nav" id="reader-nav">
        <div class="nav-dot active" data-panel="0" onclick="Reader.goToPanel(0)"></div>
        <div class="nav-dot" data-panel="1" onclick="Reader.goToPanel(1)"></div>
    </div>
</header>
<div id="loading" style="text-align:center; padding:20px; display:none;">Âä†ËΩΩ‰∏≠...</div>

<div class="reader-container">
    <div class="reader-track" id="reader-track">
        
        <!-- PANEL 1: BIBLE TEXT -->
        <div class="reader-panel" id="bible-panel">
            <div class="panel-content">
                <h2 style="color:var(--primary);">‰ªäÊó•ÁªèÊñá</h2>
                <div id="full-scripture-content">
                    <p style="color:#666;" id="bible-debug">Initializing UI...</p>
                </div>
            </div>
        </div>

        <!-- PANEL 2: DEVOTIONAL -->
        <div class="reader-panel" id="devotional-panel">
            <div class="panel-content" id="content">
                <div id="scripture"></div>
                <h2 id="day-title"></h2>
                <div id="devotional-content"></div>
                <div id="key-verse"></div>
                
                <div class="nav-buttons">
                    <button id="prev-btn" onclick="adjustDay(-1)">‰∏ä‰∏ÄÊó•</button>
                    <button id="next-btn" onclick="adjustDay(1)">‰∏ã‰∏ÄÊó•</button>
                </div>

                <footer style="text-align: center; padding: 20px 20px 0 20px; color: #666; font-size: 0.85em; line-height: 1.6; border-top: 1px dashed #eee; margin-top: 30px;">
                    ÂÜÖÂÆπÊù•Ê∫êÔºö„ÄäÊØèÂ§©‰∏é‰∏ªÂêåË°å„Äã¬∑ ËãèÈ¢ñÊô∫ Ëëó
                </footer>
            </div>
        </div>
        
    </div>
</div>


<script>
/**
 * Swipeable Bible Reader Logic
 * Handles scripture parsing, XML fetching, and Swipe UI management.
 */
const Reader = {
    // Book abbreviation map (Chinese -> ID 1-66)
    bookMap: {
        'Âàõ': 1, 'Âá∫': 2, 'Âà©': 3, 'Ê∞ë': 4, 'Áî≥': 5,
        '‰π¶': 6, 'Â£´': 7, 'Âæó': 8, 'Êíí‰∏ä': 9, 'Êíí‰∏ã': 10,
        'Áéã‰∏ä': 11, 'Áéã‰∏ã': 12, '‰ª£‰∏ä': 13, '‰ª£‰∏ã': 14, 'Êãâ': 15,
        'Â∞º': 16, 'ÊñØ': 17, '‰ºØ': 18, 'ËØó': 19, 'ÁÆ¥': 20,
        '‰º†': 21, 'Ê≠å': 22, 'Ëµõ': 23, 'ËÄ∂': 24, 'ÂìÄ': 25,
        'Áªì': 26, '‰ΩÜ': 27, '‰Ωï': 28, 'Áè•': 29, 'Êë©': 30,
        '‰øÑ': 31, 'Êãø': 32, 'Âº•': 33, 'È∏ø': 34, 'Âìà': 35,
        'Áï™': 36, 'ËØ•': 37, '‰∫ö': 38, 'Áéõ': 39,
        'Â§™': 40, 'ÂèØ': 41, 'Ë∑Ø': 42, 'Á∫¶': 43, 'Âæí': 44,
        'ÁΩó': 45, 'ÊûóÂâç': 46, 'ÊûóÂêé': 47, 'Âä†': 48, 'Âºó': 49,
        'ËÖì': 50, 'Ë•ø': 51, 'Â∏ñÂâç': 52, 'Â∏ñÂêé': 53, 'ÊèêÂâç': 54,
        'ÊèêÂêé': 55, 'Â§ö': 56, 'Èó®': 57, 'Êù•': 58, 'ÈõÖ': 59,
        'ÂΩºÂâç': 60, 'ÂΩºÂêé': 61, 'Á∫¶‰∏Ä': 62, 'Á∫¶‰∫å': 63, 'Á∫¶‰∏â': 64,
        'Áäπ': 65, 'ÂêØ': 66
    },

    // Convert Chinese number string to Integer
    chineseToArabic: function(cnNum) {
        if (!cnNum) return 0;
        const map = {
            'Èõ∂': 0, '‰∏Ä': 1, '‰∫å': 2, '‰∏â': 3, 'Âõõ': 4, 
            '‰∫î': 5, 'ÂÖ≠': 6, '‰∏É': 7, 'ÂÖ´': 8, '‰πù': 9,
            'ÂçÅ': 10, 'Âªø': 20, 'ÂçÖ': 30, 'Áôæ': 100
        };
        
        let result = 0;
        let temp = 0; 
        
        if (cnNum.startsWith('Áôæ')) return 100 + this.chineseToArabic(cnNum.substring(1));
        
        // Handle Âªø, ÂçÖ special chars
        if (cnNum.startsWith('Âªø')) cnNum = "‰∫åÂçÅ" + cnNum.substring(1);
        if (cnNum.startsWith('ÂçÖ')) cnNum = "‰∏âÂçÅ" + cnNum.substring(1);

        let total = 0;
        // Check for hundred
        if (cnNum.indexOf('Áôæ') > -1) {
            let parts = cnNum.split('Áôæ');
            let hundreds = map[parts[0]] || 1; 
            total += hundreds * 100;
            cnNum = parts[1];
            if (!cnNum) return total;
        }
        
        // Handle ÂçÅ
        if (cnNum.indexOf('ÂçÅ') > -1) {
            let parts = cnNum.split('ÂçÅ');
            let tens = parts[0] ? map[parts[0]] : 1; 
            total += tens * 10;
            cnNum = parts[1];
        }
        
        if (cnNum) {
            total += map[cnNum] || 0;
        }
        
        return total;
    },

    /**
     * Parse scripture string into object
     * @param {string} scripture e.g. "Âàõ‰∏ÄËá≥‰∫åÁ´†", "Âàõ48:21", "ËØó102"
     * @returns {object|null} { bookId: number, startChapter: number, endChapter: number }
     */
    parseScripture: function(scripture) {
        if (!scripture) return null;
        
        // 1. Identify Book
        const books = Object.keys(this.bookMap).sort((a, b) => b.length - a.length);
        let bookAbbr = null;
        let remaining = scripture;
        
        for (const book of books) {
            if (scripture.startsWith(book)) {
                bookAbbr = book;
                remaining = scripture.substring(book.length).trim();
                break;
            }
        }
        
        if (!bookAbbr) return null; 
        const bookId = this.bookMap[bookAbbr];
        
        // 2. Parse Chapter/Range
        let startChap = 1;
        let endChap = 1;
        
        // Case A: Arabic Numbers
        if (/^\d/.test(remaining)) {
            const match = remaining.match(/^(\d+)(?:[:\.]\d+)?(?:-(\d+)(?:[:\.]\d+)?)?/);
            if (match) {
                startChap = parseInt(match[1]);
                if (match[2]) {
                    endChap = parseInt(match[2]);
                } else {
                    endChap = startChap;
                }
            }
        } 
        // Case B: Chinese Numbers
        else {
            remaining = remaining.replace(/[Á´†ÁØá]/g, '');
            const parts = remaining.split('Ëá≥');
            startChap = this.chineseToArabic(parts[0].trim());
            
            if (parts.length > 1) {
                endChap = this.chineseToArabic(parts[1].trim());
            } else {
                endChap = startChap;
            }
        }
        
        return {
            bookId: bookId,
            bookName: bookAbbr,
            startChapter: startChap,
            endChapter: endChap
        };
    },

    // Initialization
    init: function() {
        this.track = document.getElementById('reader-track');
        this.dots = document.querySelectorAll('.nav-dot');
        this.currentPanel = 0; 
        
        // Load saved mode
        this.mode = localStorage.getItem('readerMode') || 'classic';
        if (this.mode === 'classic') {
            document.body.classList.add('mode-classic');
            document.getElementById('mode-toggle').innerText = 'üìë'; // Icon for Classic
        } else {
            document.getElementById('mode-toggle').innerText = 'üìñ'; // Icon for Swipe
        }

        // Touch handling
        let startX = 0;
        const threshold = 50;
        const container = document.querySelector('.reader-container');
        
        if (container) {
            container.addEventListener('touchstart', (e) => {
                if (this.mode === 'classic') return; // Disable swipe in classic mode
                startX = e.touches[0].clientX;
            }, {passive: true});
            
            container.addEventListener('touchend', (e) => {
                if (this.mode === 'classic') return; // Disable swipe in classic mode
                const diff = startX - e.changedTouches[0].clientX;
                if (Math.abs(diff) > threshold) {
                    if (diff > 0) {
                        this.goToPanel(Math.min(this.currentPanel + 1, 1));
                    } else {
                        this.goToPanel(Math.max(this.currentPanel - 1, 0));
                    }
                }
            }, {passive: true});
        }
        
        // Explicitly load bible XML if not already loaded to ensure readyness
        if (window.loadBibleXML) window.loadBibleXML();
    },
    
    // Toggle Mode
    toggleMode: function() {
        if (this.mode === 'swipe') {
            this.mode = 'classic';
            document.body.classList.add('mode-classic');
            document.getElementById('mode-toggle').innerText = 'üìë';
            // In classic mode, we just see devotional (panel 1 in DOM, effectively)
        } else {
            this.mode = 'swipe';
            document.body.classList.remove('mode-classic');
            document.getElementById('mode-toggle').innerText = 'üìñ';
            // Switch back to Bible Panel (0) by default when returning to swipe mode
            this.goToPanel(0);
        }
        localStorage.setItem('readerMode', this.mode);
    },
    
    // Switch panels
    goToPanel: function(index) {
        if (!this.track) this.init();
        
        // Scroll to top when switching panels
        window.scrollTo(0, 0);
        
        this.currentPanel = index;
        const translate = index * -50;
        if (this.track) this.track.style.transform = `translateX(${translate}%)`;
        
        this.dots.forEach((dot, i) => {
            if (i === index) dot.classList.add('active');
            else dot.classList.remove('active');
        });
    },
    
    // Render Bible Text
    renderBible: async function(scriptureStr) {
        const container = document.getElementById('full-scripture-content');
        if (!container) return;
        
        container.innerHTML = '<div style="color:#666; padding:20px; text-align:center;">Âä†ËΩΩ‰∏≠...</div>';
        
        const parsed = this.parseScripture(scriptureStr);
        if (!parsed) {
            container.innerHTML = `<div style="padding:20px; color:#666;">Êó†Ê≥ïËß£ÊûêÁªèÊñá: ${scriptureStr}</div>`;
            return;
        }
        
        const xml = await window.loadBibleXML(); 
        if (!xml) {
            container.innerHTML = '<div style="color:red;">Êó†Ê≥ïÂä†ËΩΩÂú£ÁªèÊï∞ÊçÆXML</div>';
            return;
        }
        
        let html = '';
        const bookNode = xml.querySelector(`book[number="${parsed.bookId}"]`);
        
        if (!bookNode) {
            container.innerHTML = `<div style="color:red;">Êú™ÊâæÂà∞‰π¶Âç∑ ID: ${parsed.bookId} (${parsed.bookName})</div>`;
            return;
        }
        
        for (let c = parsed.startChapter; c <= parsed.endChapter; c++) {
            const chapterNode = bookNode.querySelector(`chapter[number="${c}"]`);
            if (chapterNode) {
                html += `<div class="bible-chapter">
                    <h3>${parsed.bookName} Á¨¨${c}Á´†</h3>`;
                
                const verses = chapterNode.querySelectorAll('verse');
                verses.forEach(v => {
                    const num = v.getAttribute('number');
                    const text = v.textContent;
                    html += `<div class="bible-verse">
                        <span class="verse-num">${num}</span>${text}
                    </div>`;
                });
                
                html += `</div>`;
            } else {
                 html += `<div style="color:#999; margin:10px 0;">(Êú™ÊâæÂà∞Á¨¨${c}Á´†)</div>`;
            }
        }
        
        container.innerHTML = html || '<div>Êú™ÊâæÂà∞ÁªèÊñáÂÜÖÂÆπ</div>';
    }
};

// Expose to window
window.Reader = Reader;
</script>
<script>
    let tooltipElement = null;
    
    function createTooltip() {
        if (!tooltipElement) {
            tooltipElement = document.createElement('div');
            tooltipElement.className = 'verse-tooltip';
            document.body.appendChild(tooltipElement);
        }
        return tooltipElement;
    }
    
    function hideVerseTooltip() {
        if (tooltipElement) {
            tooltipElement.classList.remove('show');
        }
    }
    
    // Bible XML data
    let bibleXML = null;
    
    // Load Bible XML for verse tooltips
    async function loadBibleXML() {
        if (bibleXML) return bibleXML;
        
        try {
            const response = await fetch('ChineseSimplifiedBible.xml');
            const text = await response.text();
            const parser = new DOMParser();
            bibleXML = parser.parseFromString(text, 'text/xml');
            return bibleXML;
        } catch (err) {
            console.warn('Failed to load Bible XML:', err);
            return null;
        }
    }
    // Expose to window for Reader module
    window.loadBibleXML = loadBibleXML;
    
    // Map Chinese book abbreviations to book numbers (1-66)
    function getBookNumber(chineseAbbr) {
        const bookMap = {
            'Âàõ': 1, 'Âá∫': 2, 'Âà©': 3, 'Ê∞ë': 4, 'Áî≥': 5,
            '‰π¶': 6, 'Â£´': 7, 'Âæó': 8, 'Êíí‰∏ä': 9, 'Êíí‰∏ã': 10,
            'Áéã‰∏ä': 11, 'Áéã‰∏ã': 12, '‰ª£‰∏ä': 13, '‰ª£‰∏ã': 14, 'Êãâ': 15,
            'Â∞º': 16, 'ÊñØ': 17, '‰ºØ': 18, 'ËØó': 19, 'ÁÆ¥': 20,
            '‰º†': 21, 'Ê≠å': 22, 'Ëµõ': 23, 'ËÄ∂': 24, 'ÂìÄ': 25,
            'Áªì': 26, '‰ΩÜ': 27, '‰Ωï': 28, 'Áè•': 29, 'Êë©': 30,
            '‰øÑ': 31, 'Êãø': 32, 'Âº•': 33, 'È∏ø': 34, 'Âìà': 35,
            'Áï™': 36, 'ËØ•': 37, '‰∫ö': 38, 'Áéõ': 39,
            'Â§™': 40, 'ÂèØ': 41, 'Ë∑Ø': 42, 'Á∫¶': 43, 'Âæí': 44,
            'ÁΩó': 45, 'ÊûóÂâç': 46, 'ÊûóÂêé': 47, 'Âä†': 48, 'Âºó': 49,
            'ËÖì': 50, 'Ë•ø': 51, 'Â∏ñÂâç': 52, 'Â∏ñÂêé': 53, 'ÊèêÂâç': 54,
            'ÊèêÂêé': 55, 'Â§ö': 56, 'Èó®': 57, 'Êù•': 58, 'ÈõÖ': 59,
            'ÂΩºÂâç': 60, 'ÂΩºÂêé': 61, 'Á∫¶‰∏Ä': 62, 'Á∫¶‰∫å': 63, 'Á∫¶‰∏â': 64,
            'Áäπ': 65, 'ÂêØ': 66
        };
        return bookMap[chineseAbbr] || null;
    }
    
    // Get verse text from XML
    async function getVerseText(bookAbbr, chapter, verseRange) {
        const xml = await loadBibleXML();
        if (!xml) {
            console.warn('XML not loaded');
            return null;
        }
        
        const bookNum = getBookNumber(bookAbbr);
        if (!bookNum) {
            console.warn(`Unknown book: ${bookAbbr}`);
            return null;
        }
        
        try {
            const bookNode = xml.querySelector(`book[number="${bookNum}"]`);
            if (!bookNode) {
                console.warn(`Book not found: ${bookAbbr} (${bookNum})`);
                return null;
            }
            
            const chapterNode = bookNode.querySelector(`chapter[number="${chapter}"]`);
            if (!chapterNode) {
                console.warn(`Chapter not found: ${bookAbbr} ${chapter}`);
                return null;
            }
            
            // Handle verse ranges like "1-2"
            if (verseRange.includes('-')) {
                const [start, end] = verseRange.split('-').map(v => parseInt(v));
                let verses = [];
                for (let i = start; i <= end; i++) {
                    const verseNode = chapterNode.querySelector(`verse[number="${i}"]`);
                    if (verseNode) {
                        verses.push(verseNode.textContent.trim());
                    }
                }
                const result = verses.join(' ');
                console.log(`‚úì ${bookAbbr}${chapter}:${verseRange} = ${result.substring(0, 30)}...`);
                return result;
            } else {
                const verseNode = chapterNode.querySelector(`verse[number="${verseRange}"]`);
                if (!verseNode) {
                    console.warn(`Verse not found: ${bookAbbr} ${chapter}:${verseRange}`);
                    return null;
                }
                const result = verseNode.textContent.trim();
                console.log(`‚úì ${bookAbbr}${chapter}:${verseRange} = ${result.substring(0, 30)}...`);
                return result;
            }
        } catch (err) {
            console.warn('Error fetching verse:', bookAbbr, chapter, verseRange, err);
            return null;
        }
    }
    
    // Add verse references to content (now works for all days since content is normalized)
    async function enhanceVerseReferences() {
        const contentEl = document.getElementById('devotional-content');
        if (!contentEl) return;
        
        // Pattern to match verse references with optional prefix
        // Use explicit list of valid book abbreviations
        const bookNames = 'Âàõ|Âá∫|Âà©|Ê∞ë|Áî≥|‰π¶|Â£´|Âæó|Êíí‰∏ä|Êíí‰∏ã|Áéã‰∏ä|Áéã‰∏ã|‰ª£‰∏ä|‰ª£‰∏ã|Êãâ|Â∞º|ÊñØ|‰ºØ|ËØó|ÁÆ¥|‰º†|Ê≠å|Ëµõ|ËÄ∂|ÂìÄ|Áªì|‰ΩÜ|‰Ωï|Áè•|Êë©|‰øÑ|Êãø|Âº•|È∏ø|Âìà|Áï™|ËØ•|‰∫ö|Áéõ|Â§™|ÂèØ|Ë∑Ø|Á∫¶|Âæí|ÁΩó|ÊûóÂâç|ÊûóÂêé|Âä†|Âºó|ËÖì|Ë•ø|Â∏ñÂâç|Â∏ñÂêé|ÊèêÂâç|ÊèêÂêé|Â§ö|Èó®|Êù•|ÈõÖ|ÂΩºÂâç|ÂΩºÂêé|Á∫¶‰∏Ä|Á∫¶‰∫å|Á∫¶‰∏â|Áäπ|ÂêØ';
        const pattern = new RegExp(`([Ôºà(]?ÂèÇ)?(${bookNames})(\\d+):(\\d+(?:-\\d+)?)`, 'g');
        
        const matches = [];
        let match;
        const originalHTML = contentEl.innerHTML;
        
        // Skip if already processed (has verse-ref spans)
        if (originalHTML.includes('class="verse-ref"')) {
            console.log('Verses already enhanced, skipping');
            return;
        }
        
        while ((match = pattern.exec(originalHTML)) !== null) {
            const prefix = match[1] || '';
            const book = match[2];
            const chapter = match[3];
            const verse = match[4];
            const ref = `${book}${chapter}:${verse}`;
            
            matches.push({
                index: match.index,
                length: match[0].length,
                fullMatch: match[0],
                prefix: prefix,
                ref: ref,
                book: book,
                chapter: chapter,
                verse: verse
            });
        }
        
        console.log(`Found ${matches.length} verse references`);
        
        // Fetch verse text for all unique references
        const verseTexts = new Map();
        for (const m of matches) {
            if (!verseTexts.has(m.ref)) {
                const verseText = await getVerseText(m.book, m.chapter, m.verse);
                if (verseText) {
                    verseTexts.set(m.ref, verseText);
                }
            }
        }
        
        console.log(`Fetched ${verseTexts.size} unique verses`);
        
        // Replace matches from end to start to avoid index shifting
        matches.sort((a, b) => b.index - a.index);
        
        let newHTML = originalHTML;
        for (const m of matches) {
            const verseText = verseTexts.get(m.ref);
            if (verseText) {
                const escapedVerse = verseText.replace(/"/g, '&quot;');
                const replacement = `${m.prefix}<span class="verse-ref" data-ref="${m.ref}" data-verse="${escapedVerse}">${m.ref}</span>`;
                
                // Replace by position (from end to start, so indices don't shift)
                newHTML = newHTML.substring(0, m.index) + replacement + newHTML.substring(m.index + m.length);
            }
        }
        
        contentEl.innerHTML = newHTML;
        
        // Add event listeners (use 'click' which works on both desktop and mobile)
        contentEl.querySelectorAll('.verse-ref').forEach(span => {
            span.addEventListener('mouseenter', showVerseTooltipFromData);
            span.addEventListener('mouseleave', hideVerseTooltip);
            span.addEventListener('click', (e) => {
                e.preventDefault(); 
                e.stopPropagation(); // Prevent closing immediately
                showVerseTooltipFromData(e);
                
                // No auto-close timer - let user read at their own pace
                // But add scroll listener to close when scrolling starts
                
                // Remove existing scroll listener if any (to prevent duplicates)
                if (window.tooltipScrollListener) {
                    window.removeEventListener('scroll', window.tooltipScrollListener);
                }
                
                // Create new scroll listener
                window.tooltipScrollListener = function() {
                    hideVerseTooltip();
                    window.removeEventListener('scroll', window.tooltipScrollListener);
                };
                
                // Add listener with small delay to prevent immediate trigger on touch
                setTimeout(() => {
                    window.addEventListener('scroll', window.tooltipScrollListener, {passive: true});
                }, 100);
            });
        });
        
        // Close tooltip when clicking anywhere else
        document.addEventListener('click', (e) => {
             if (!e.target.closest('.verse-ref') && !e.target.closest('.verse-tooltip')) {
                 hideVerseTooltip();
             }
        });
        
        console.log('Verse enhancement complete');
    }
    
    // Show tooltip using data attribute
    function showVerseTooltipFromData(event) {
        const ref = event.target.dataset.ref;
        const verseText = event.target.dataset.verse;
        
        console.log('Tooltip triggered:', ref, verseText ? 'has text' : 'no text');
        
        if (!verseText) return;
        
        const tooltip = createTooltip();
        tooltip.innerHTML = `<span class="verse-tooltip-ref">${ref}</span>${verseText}`;
        tooltip.classList.add('show');
        
        const x = event.clientX;
        const y = event.clientY;
        const tooltipRect = tooltip.getBoundingClientRect();
        
        const screenW = window.innerWidth;
        const screenH = window.innerHeight;
        const padding = 10;
        
        // Horizontal: Attempt to center on click, but clamp to screen edges
        let left = x - (tooltipRect.width / 2);
        
        // Clamp Horizontal
        if (left < padding) left = padding;
        if (left + tooltipRect.width > screenW - padding) {
            left = screenW - tooltipRect.width - padding;
        }
        
        // Vertical: Prefer bottom, flip to top if insufficient space
        // Check space below
        const spaceBelow = screenH - y;
        const spaceAbove = y;
        
        let top;
        // If enough space below (allow 20px gap) OR not enough space above either
        if (spaceBelow > tooltipRect.height + 20 || spaceBelow > spaceAbove) {
            top = y + 20;
        } else {
            // Place above
            top = y - tooltipRect.height - 20;
        }
        
        // Final Vertical Clamp (ensure it never goes off screen)
        // Reserve 80px at top for header if possible
        if (top < 80) top = 80;
        if (top + tooltipRect.height > screenH - padding) {
             top = screenH - tooltipRect.height - padding;
        }
        
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
        
        console.log('Tooltip positioned at:', left, top);
    }

    // Load data from bibleData.json (generated by extractor). Falls back to a
    // friendly message if the file is missing or parsing fails.
    let bibleData = [];
    // Default current day is day 1 for fresh users (index 0). A saved value
    // in localStorage overrides this. (Previously we computed a default from
    // Jan 1 of the current year; keep that helper for advanced uses.)
    function computeDefaultDayIndex() {
        const now = new Date();
        // Jan 1 of current year
        const start = new Date(now.getFullYear(), 0, 1);
        const msPerDay = 24 * 60 * 60 * 1000;
        const diff = Math.floor((now.setHours(0,0,0,0) - start.setHours(0,0,0,0)) / msPerDay);
        return diff >= 0 ? diff : 0;
    }
    const saved = localStorage.getItem('savedDay');
    let currentDayIndex;
    if (saved !== null) {
        currentDayIndex = parseInt(saved, 10);
    } else {
        // New users start at day 1 (index 0). If you want the old behavior
        // (default based on Jan 1), replace the following line with
        // computeDefaultDayIndex().
        currentDayIndex = 0;
    }

    // Get or set the start date for the reading plan
    // First-time visitors: current date becomes Day 1 Week 1
    function getStartDate() {
        let startDateStr = localStorage.getItem('readingPlanStartDate');
        if (!startDateStr) {
            // First time visitor - use today as Day 1
            const today = new Date();
            startDateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            localStorage.setItem('readingPlanStartDate', startDateStr);
        }
        const [year, month, day] = startDateStr.split('-').map(Number);
        return new Date(year, month - 1, day);
    }

    const PLAN_START_DATE = getStartDate();
    
    // Chapter index for Bible chapter navigation
    const chapterIndex = [];
    
    // Get canonical Bible book order (1-66)
    function getBookOrder(abbr) {
        const bookOrder = {
            // Old Testament (1-39)
            'Âàõ': 1, 'Âá∫': 2, 'Âà©': 3, 'Ê∞ë': 4, 'Áî≥': 5,
            '‰π¶': 6, 'Â£´': 7, 'Âæó': 8, 'Êíí‰∏ä': 9, 'Êíí‰∏ã': 10,
            'Áéã‰∏ä': 11, 'Áéã‰∏ã': 12, '‰ª£‰∏ä': 13, '‰ª£‰∏ã': 14, 'Êãâ': 15,
            'Â∞º': 16, 'ÊñØ': 17, '‰ºØ': 18, 'ËØó': 19, 'ÁÆ¥': 20,
            '‰º†': 21, 'Ê≠å': 22, 'Ëµõ': 23, 'ËÄ∂': 24, 'ÂìÄ': 25,
            'Áªì': 26, '‰ΩÜ': 27, '‰Ωï': 28, 'Áè•': 29, 'Êë©': 30,
            '‰øÑ': 31, 'Êãø': 32, 'Âº•': 33, 'È∏ø': 34, 'Âìà': 35,
            'Áï™': 36, 'ËØ•': 37, '‰∫ö': 38, 'Áéõ': 39,
            // New Testament (40-66)
            'Â§™': 40, 'ÂèØ': 41, 'Ë∑Ø': 42, 'Á∫¶': 43, 'Âæí': 44,
            'ÁΩó': 45, 'ÊûóÂâç': 46, 'ÊûóÂêé': 47, 'Âä†': 48, 'Âºó': 49,
            'ËÖì': 50, 'Ë•ø': 51, 'Â∏ñÂâç': 52, 'Â∏ñÂêé': 53, 'ÊèêÂâç': 54,
            'ÊèêÂêé': 55, 'Â§ö': 56, 'Èó®': 57, 'Êù•': 58, 'ÈõÖ': 59,
            'ÂΩºÂâç': 60, 'ÂΩºÂêé': 61, 'Á∫¶‰∏Ä': 62, 'Á∫¶‰∫å': 63, 'Á∫¶‰∏â': 64,
            'Áäπ': 65, 'ÂêØ': 66
        };
        return bookOrder[abbr] || 999;
    }
    
    // Map abbreviations to full book names
    function getFullBookName(abbr) {
        const bookNames = {
            'Âàõ': 'Âàõ‰∏ñËÆ∞', 'Âá∫': 'Âá∫ÂüÉÂèäËÆ∞', 'Âà©': 'Âà©Êú™ËÆ∞',
            'Ê∞ë': 'Ê∞ëÊï∞ËÆ∞', 'Áî≥': 'Áî≥ÂëΩËÆ∞', '‰π¶': 'Á∫¶‰π¶‰∫öËÆ∞',
            'Â£´': 'Â£´Â∏àËÆ∞', 'Âæó': 'Ë∑ØÂæóËÆ∞', 'Êíí‰∏ä': 'ÊííÊØçËÄ≥ËÆ∞‰∏ä',
            'Êíí‰∏ã': 'ÊííÊØçËÄ≥ËÆ∞‰∏ã', 'Áéã‰∏ä': 'ÂàóÁéãÁ∫™‰∏ä', 'Áéã‰∏ã': 'ÂàóÁéãÁ∫™‰∏ã',
            '‰ª£‰∏ä': 'ÂéÜ‰ª£Âøó‰∏ä', '‰ª£‰∏ã': 'ÂéÜ‰ª£Âøó‰∏ã', 'Êãâ': '‰ª•ÊñØÊãâËÆ∞',
            'Â∞º': 'Â∞ºÂ∏åÁ±≥ËÆ∞', 'ÊñØ': '‰ª•ÊñØÂ∏ñËÆ∞', '‰ºØ': 'Á∫¶‰ºØËÆ∞',
            'ËØó': 'ËØóÁØá', 'ÁÆ¥': 'ÁÆ¥Ë®Ä', '‰º†': '‰º†ÈÅì‰π¶', 'Ê≠å': 'ÈõÖÊ≠å',
            'Ëµõ': '‰ª•Ëµõ‰∫ö‰π¶', 'ËÄ∂': 'ËÄ∂Âà©Á±≥‰π¶', 'ÂìÄ': 'ËÄ∂Âà©Á±≥ÂìÄÊ≠å',
            'Áªì': '‰ª•Ë•øÁªì‰π¶', '‰ΩÜ': '‰ΩÜ‰ª•ÁêÜ‰π¶', '‰Ωï': '‰ΩïË•øÈòø‰π¶',
            'Áè•': 'Á∫¶Áè•‰π¶', 'Êë©': 'ÈòøÊë©Âè∏‰π¶', '‰øÑ': '‰øÑÂ∑¥Â∫ï‰∫ö‰π¶',
            'Êãø': 'Á∫¶Êãø‰π¶', 'Âº•': 'Âº•Ëø¶‰π¶', 'È∏ø': 'ÈÇ£È∏ø‰π¶',
            'Âìà': 'ÂìàÂ∑¥Ë∞∑‰π¶', 'Áï™': 'Ë•øÁï™ÈõÖ‰π¶', 'ËØ•': 'ÂìàËØ•‰π¶',
            '‰∫ö': 'ÊííËø¶Âà©‰∫ö‰π¶', 'Áéõ': 'ÁéõÊãâÂü∫‰π¶',
            'Â§™': 'È©¨Â§™Á¶èÈü≥', 'ÂèØ': 'È©¨ÂèØÁ¶èÈü≥', 'Ë∑Ø': 'Ë∑ØÂä†Á¶èÈü≥',
            'Á∫¶': 'Á∫¶Áø∞Á¶èÈü≥', 'Âæí': '‰ΩøÂæíË°å‰º†', 'ÁΩó': 'ÁΩóÈ©¨‰π¶',
            'ÊûóÂâç': 'Âì•ÊûóÂ§öÂâç‰π¶', 'ÊûóÂêé': 'Âì•ÊûóÂ§öÂêé‰π¶', 'Âä†': 'Âä†ÊãâÂ§™‰π¶',
            'Âºó': '‰ª•ÂºóÊâÄ‰π¶', 'ËÖì': 'ËÖìÁ´ãÊØî‰π¶', 'Ë•ø': 'Ê≠åÁΩóË•ø‰π¶',
            'Â∏ñÂâç': 'Â∏ñÊííÁΩóÂ∞ºËø¶Ââç‰π¶', 'Â∏ñÂêé': 'Â∏ñÊííÁΩóÂ∞ºËø¶Âêé‰π¶',
            'ÊèêÂâç': 'ÊèêÊë©Â§™Ââç‰π¶', 'ÊèêÂêé': 'ÊèêÊë©Â§™Âêé‰π¶', 'Â§ö': 'ÊèêÂ§ö‰π¶',
            'Èó®': 'ËÖìÂà©Èó®‰π¶', 'Êù•': 'Â∏å‰ºØÊù•‰π¶', 'ÈõÖ': 'ÈõÖÂêÑ‰π¶',
            'ÂΩºÂâç': 'ÂΩºÂæóÂâç‰π¶', 'ÂΩºÂêé': 'ÂΩºÂæóÂêé‰π¶', 'Á∫¶‰∏Ä': 'Á∫¶Áø∞‰∏Ä‰π¶',
            'Á∫¶‰∫å': 'Á∫¶Áø∞‰∫å‰π¶', 'Á∫¶‰∏â': 'Á∫¶Áø∞‰∏â‰π¶', 'Áäπ': 'ÁäπÂ§ß‰π¶',
            'ÂêØ': 'ÂêØÁ§∫ÂΩï'
        };
        return bookNames[abbr] || abbr;
    }
    
    // Build chapter index from data
    function buildChapterIndex() {
        if (!bibleData || bibleData.length === 0) return;
        
        bibleData.forEach((entry, idx) => {
            const scripture = entry.scripture || '';
            // Extract book name (everything before numbers/Á´†/ÁØá)
            const match = scripture.match(/^([^‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅÂªøÂçÖ\d]+)/);
            if (match) {
                const book = match[1].trim();
                const chapterPart = scripture.substring(book.length).trim();
                
                chapterIndex.push({
                    index: idx,
                    book: book,
                    bookFull: getFullBookName(book),
                    bookOrder: getBookOrder(book),
                    chapterPart: chapterPart,
                    scripture: scripture,
                    dayLabel: entry.day_label
                });
            }
        });
        
        // Sort by book order
        chapterIndex.sort((a, b) => {
            if (a.bookOrder !== b.bookOrder) {
                return a.bookOrder - b.bookOrder;
            }
            return a.index - b.index;
        });
    }


    // DOM helpers to avoid runtime errors when an element is missing
    function el(id){ return document.getElementById(id); }
    function setText(id, txt){ const e = el(id); if(e) e.innerText = txt; else console.warn('Missing element:', id); }
    function setHTML(id, html){ const e = el(id); if(e) e.innerHTML = html; else console.warn('Missing element:', id); }
    function setDisabled(id, v){ const e = el(id); if(e) e.disabled = v; else console.warn('Missing element:', id); }


    // Populate chapter dropdown based on chapter index
    function populateChapterDropdown() {
        const chapterSelect = document.getElementById('jump-chapter');
        if (!chapterSelect || chapterIndex.length === 0) return;
        
        chapterSelect.innerHTML = '<option value="">ÈÄâÊã©Á´†ËäÇ...</option>';
        
        chapterIndex.forEach(item => {
            const option = document.createElement('option');
            option.value = item.index;
            option.textContent = `${item.bookFull} ${item.chapterPart}`;
            chapterSelect.appendChild(option);
        });
    }

    // Wire up chapter selector after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        const jchapter = document.getElementById('jump-chapter');
        
        // Chapter selector: jump and reset
        if (jchapter) {
            jchapter.addEventListener('change', () => {
                const idx = parseInt(jchapter.value, 10);
                if (!isNaN(idx) && idx >= 0) {
                    currentDayIndex = idx;
                    localStorage.setItem('savedDay', currentDayIndex);
                    renderDay();
                    // Reset chapter selector for next use
                    jchapter.value = '';
                }
            });
        }
    });

    function renderDay() {
        try {
        if (!bibleData || bibleData.length === 0) {
            setText('day-title', 'Êú™ÊâæÂà∞Êï∞ÊçÆ');
            setText('devotional-content', 'ËØ∑ÂÖàËøêË°åÊèêÂèñÂô®ÁîüÊàê bibleData.jsonÔºåÁÑ∂ÂêéÂà∑Êñ∞È°µÈù¢„ÄÇ');

            setText('scripture', '');
            setText('key-verse', '');
            setDisabled('prev-btn', true);
            setDisabled('next-btn', true);
            return;
        }

        // clamp index
        if (currentDayIndex < 0) currentDayIndex = 0;
        if (currentDayIndex >= bibleData.length) currentDayIndex = bibleData.length - 1;

        const data = bibleData[currentDayIndex];
        
        // Display week and day number for debugging
        const weekNum = Math.floor(currentDayIndex / 6) + 1;
        const dayNum = (currentDayIndex % 6) + 1;
        setText('week-day-info', `Á¨¨${weekNum}Âë® Á¨¨${dayNum}Êó• (Á¥¢Âºï: ${currentDayIndex})`);
        
        setText('scripture', data.scripture || '');
        setText('day-title', data.title || '');

        // allow HTML in content if present (tables, lists, paragraphs), otherwise plain text
        const contentEl = el('devotional-content');
        if (contentEl) {
            // Check for common HTML tags to decide whether to render as HTML
            if (data.content && /\<\/?(table|tr|td|th|div|p|ol|ul|li|dl|dt|dd|blockquote|br|b|i|strong|em|h[1-6])/i.test(data.content)) {
                contentEl.innerHTML = data.content;
            } else {
                contentEl.innerText = data.content || '';
            }
        }

        // Display verse text if available, otherwise just show the reference
        const verseEl = el('key-verse');
        if (verseEl) {
            let verseHtml = '';
            if (data.verse_parts && data.verse_parts.length > 0) {
                // Display each verse part with its individual reference
                verseHtml = data.verse_parts.map(part => 
                    `<div style="margin-bottom: 12px;"><strong>${part.reference}</strong><br>${part.text}</div>`
                ).join('');
            } else if (data.verse_text) {
                verseHtml = `<strong>${data.verse}</strong><br>${data.verse_text}`;
            } else {
                verseHtml = data.verse || '';
            }
            
            // Wrap in styled box with label
            if (verseHtml) {
                verseEl.innerHTML = `<div class="verse-box" style="margin-top:0; margin-bottom:20px;">
                    <strong style="color:var(--primary); display:block; margin-bottom:8px;">‰ªäÊó•ÈáëÂè•Ôºö</strong>
                    ${verseHtml}
                </div>`;
            } else {
                verseEl.innerHTML = '';
            }
        }

        setDisabled('prev-btn', currentDayIndex === 0);
        setDisabled('next-btn', currentDayIndex === bibleData.length - 1);
        if (window.Reader) {
            window.Reader.goToPanel(0);
            window.Reader.renderBible(data.scripture);
        }
        } catch (err) {
            console.error('renderDay failed:', err);
            // diagnostic: list key elements and their presence
            const ids = ['date-display','day-num-text','day-date','scripture','day-title','devotional-content','reflection','key-verse','prev-btn','next-btn'];
            ids.forEach(id => console.warn(id, !!document.getElementById(id)));
        }

        localStorage.setItem('savedDay', currentDayIndex);
        window.scrollTo(0,0);
        
        // Add verse tooltips immediately (no delay for better mobile responsiveness)
        enhanceVerseReferences();
    }

    function adjustDay(step) {
        // For 6-day reading plan: data indices are continuous (0,1,2,3,4,5,6,7...)
        // but calendar dates skip every 7th day (Jan 1,2,3,4,5,6,8,9,10,11,12,13,15...)
        // So we just increment/decrement the data index normally
        currentDayIndex += step;
        renderDay();
    }

    // Wire up chapter selector and fetch data after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        const jchapter = document.getElementById('jump-chapter');
        
        // Chapter selector: jump and reset
        if (jchapter) {
            jchapter.addEventListener('change', () => {
                const idx = parseInt(jchapter.value, 10);
                if (!isNaN(idx) && idx >= 0) {
                    currentDayIndex = idx;
                    renderDay();
                    // Reset dropdown after selection so it can be reused
                    jchapter.value = "";
                }
            });
        }
        
        // Fetch bibleData.json from the same directory
        fetch('bibleData.json', { cache: 'no-store' })
            .then(r => {
                if (!r.ok) throw new Error('ÁΩëÁªúÈîôËØØÔºö' + r.status);
                return r.json();
            })
            .then(json => {
                // some extractors put the days array at the top-level; accept either
                // an array or an object with a top-level array.
                if (Array.isArray(json)) bibleData = json;
                else if (Array.isArray(json.data)) bibleData = json.data;
                else bibleData = json;
                
                buildChapterIndex();
                populateChapterDropdown();
                
                // Initialize Reader
                if (window.Reader) window.Reader.init();
                
                renderDay();
            })
            .catch(err => {
                console.warn('Êó†Ê≥ïÂä†ËΩΩ bibleData.json:', err);
                const debugEl = document.getElementById('full-scripture-content');
                if (debugEl) debugEl.innerHTML = '<p style="color:red">Êó†Ê≥ïÂä†ËΩΩÊï∞ÊçÆ: ' + err.message + '</p>';
                bibleData = [];
                renderDay();
            });
    });

    // Ê≥®ÂÜå Service Worker
    if ('serviceWorker' in navigator) {
        // version string appended to service worker URL to force reload when we change the file
        const APP_SW_VERSION = 'v10'; // Bump version
        window.addEventListener('load', () => {
            navigator.serviceWorker.register(`sw.js?${APP_SW_VERSION}`)
              .then(reg => console.log('sw registered:', reg.scope))
              .catch(err => console.warn('sw registration failed:', err));
        });
    }
</script>
</body>
</html>