<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>每天与主同行</title>
    <!-- versioned manifest to bust cache when we update the app -->
    <link rel="manifest" href="manifest.json?v=3">
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <link rel="icon" href="./icons/icon-192.png" sizes="192x192" />
    <link rel="icon" href="./icons/icon-512.png" sizes="512x512" />
    <link rel="mask-icon" href="./icons/icon.svg" color="#4A90E2">
    
    <style>
        :root { --primary: #4A90E2; --bg: #f5f7fa; --text: #333; }
        body { font-family: -apple-system, "PingFang SC", "Helvetica Neue", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        header { background: var(--primary); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; line-height: 1.8; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .scripture-ref { font-weight: bold; color: var(--primary); font-size: 1.1em; display: block; margin-bottom: 10px; }
        h2 { margin: 0 0 15px 0; font-size: 1.4em; }
        .section-title { font-weight: bold; border-left: 4px solid var(--primary); padding-left: 10px; margin: 25px 0 10px 0; }
        .verse-box { background: #eef5ff; border-radius: 8px; padding: 15px; font-style: italic; color: #444; margin-top: 20px; border: 1px dashed var(--primary); }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        button { border: none; background: var(--primary); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; cursor: pointer; transition: opacity 0.2s; }
        button:disabled { background: #ccc; }
        .day-indicator { color: var(--text); line-height: 36px; font-weight: bold; }
        .commentary-box {
            background-color: #f9fafb;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            font-size: 0.95em;
            color: #444;
        }
        .commentary-box h5 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: var(--primary);
        }
        /* Table styling for extracted tables inserted into content */
        #devotional-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            table-layout: auto;
            font-size: 0.95em;
        }
        #devotional-content th,
        #devotional-content td {
            border: 1px solid #e0e6ef;
            padding: 8px 10px;
            vertical-align: top;
        }
        #devotional-content thead th {
            background: #f7f9fc;
            color: var(--text);
            font-weight: 600;
        }
        /* small responsive tweak for very small screens */
        @media (max-width: 420px) {
            #devotional-content th, #devotional-content td { padding: 6px; font-size: 0.9em; }
        }
        
        /* Verse reference hover styles */
        .verse-ref {
            cursor: help;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-decoration-color: var(--primary);
            color: inherit;
            position: relative;
        }
        
        .verse-tooltip {
            position: fixed;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-width: 320px;
            z-index: 2000;
            font-size: 0.9em;
            line-height: 1.6;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            .verse-tooltip {
                max-width: 90vw;
                font-size: 1em;
                padding: 16px 20px;
                border-width: 3px;
                box-shadow: 0 6px 20px rgba(0,0,0,0.3);
                left: 5vw !important;
                right: 5vw !important;
                top: 50% !important;
                transform: translateY(-50%);
                width: auto;
            }
        }
        
        .verse-tooltip.show {
            opacity: 1;
        }
        
        .verse-tooltip-ref {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
            display: block;
            font-size: 0.95em;
            pointer-events: none;
        }
        
        .verse-tooltip * {
            pointer-events: none;
        }
    </style>
</head>
<body>

<header>
    <h1 id="app-title" style="margin: 5px 0; font-size: 1.2em;">每天与主同行</h1>
    <div style="margin-top:8px; display:flex; justify-content:center; gap:8px; align-items:center;">
        <!-- Chapter selector -->
        <select id="jump-chapter" aria-label="选择章节" style="padding:6px 8px; border-radius:6px; border:1px solid #ddd; background:white; font-size:14px; min-width:200px;">
            <option value="">选择章节...</option>
            <!-- Populated dynamically -->
        </select>
    </div>
</header>

<div class="container">
    <div class="card" id="content-card">
        <div style="color: #666; font-size: 0.85em; margin-bottom: 8px;" id="week-day-info"></div>
        <span class="scripture-ref" id="scripture"></span>
        <h2 id="day-title">载入中...</h2>
        <div id="devotional-content"></div>
        

        
        <div class="verse-box">
            <strong>今日金句：</strong><br>
            <span id="key-verse"></span>
        </div>
    </div>
</div>

    <div class="nav-bar">
    <button onclick="changeDay(-1)" id="prev-btn">前一天</button>
    <button onclick="changeDay(1)" id="next-btn">后一天</button>
</div>

<footer style="text-align: center; padding: 20px 20px 100px 20px; color: #666; font-size: 0.85em; line-height: 1.6;">
    内容来源：《每天与主同行》· 苏颖智 著
</footer>

<script>
    let tooltipElement = null;
    
    function createTooltip() {
        if (!tooltipElement) {
            tooltipElement = document.createElement('div');
            tooltipElement.className = 'verse-tooltip';
            document.body.appendChild(tooltipElement);
        }
        return tooltipElement;
    }
    
    function hideVerseTooltip() {
        if (tooltipElement) {
            tooltipElement.classList.remove('show');
        }
    }
    
    // Bible XML data
    let bibleXML = null;
    
    // Load Bible XML for verse tooltips
    async function loadBibleXML() {
        if (bibleXML) return bibleXML;
        
        try {
            const response = await fetch('ChineseSimplifiedBible.xml');
            const text = await response.text();
            const parser = new DOMParser();
            bibleXML = parser.parseFromString(text, 'text/xml');
            return bibleXML;
        } catch (err) {
            console.warn('Failed to load Bible XML:', err);
            return null;
        }
    }
    
    // Map Chinese book abbreviations to book numbers (1-66)
    function getBookNumber(chineseAbbr) {
        const bookMap = {
            '创': 1, '出': 2, '利': 3, '民': 4, '申': 5,
            '书': 6, '士': 7, '得': 8, '撒上': 9, '撒下': 10,
            '王上': 11, '王下': 12, '代上': 13, '代下': 14, '拉': 15,
            '尼': 16, '斯': 17, '伯': 18, '诗': 19, '箴': 20,
            '传': 21, '歌': 22, '赛': 23, '耶': 24, '哀': 25,
            '结': 26, '但': 27, '何': 28, '珥': 29, '摩': 30,
            '俄': 31, '拿': 32, '弥': 33, '鸿': 34, '哈': 35,
            '番': 36, '该': 37, '亚': 38, '玛': 39,
            '太': 40, '可': 41, '路': 42, '约': 43, '徒': 44,
            '罗': 45, '林前': 46, '林后': 47, '加': 48, '弗': 49,
            '腓': 50, '西': 51, '帖前': 52, '帖后': 53, '提前': 54,
            '提后': 55, '多': 56, '门': 57, '来': 58, '雅': 59,
            '彼前': 60, '彼后': 61, '约一': 62, '约二': 63, '约三': 64,
            '犹': 65, '启': 66
        };
        return bookMap[chineseAbbr] || null;
    }
    
    // Get verse text from XML
    async function getVerseText(bookAbbr, chapter, verseRange) {
        const xml = await loadBibleXML();
        if (!xml) {
            console.warn('XML not loaded');
            return null;
        }
        
        const bookNum = getBookNumber(bookAbbr);
        if (!bookNum) {
            console.warn(`Unknown book: ${bookAbbr}`);
            return null;
        }
        
        try {
            const bookNode = xml.querySelector(`book[number="${bookNum}"]`);
            if (!bookNode) {
                console.warn(`Book not found: ${bookAbbr} (${bookNum})`);
                return null;
            }
            
            const chapterNode = bookNode.querySelector(`chapter[number="${chapter}"]`);
            if (!chapterNode) {
                console.warn(`Chapter not found: ${bookAbbr} ${chapter}`);
                return null;
            }
            
            // Handle verse ranges like "1-2"
            if (verseRange.includes('-')) {
                const [start, end] = verseRange.split('-').map(v => parseInt(v));
                let verses = [];
                for (let i = start; i <= end; i++) {
                    const verseNode = chapterNode.querySelector(`verse[number="${i}"]`);
                    if (verseNode) {
                        verses.push(verseNode.textContent.trim());
                    }
                }
                const result = verses.join(' ');
                console.log(`✓ ${bookAbbr}${chapter}:${verseRange} = ${result.substring(0, 30)}...`);
                return result;
            } else {
                const verseNode = chapterNode.querySelector(`verse[number="${verseRange}"]`);
                if (!verseNode) {
                    console.warn(`Verse not found: ${bookAbbr} ${chapter}:${verseRange}`);
                    return null;
                }
                const result = verseNode.textContent.trim();
                console.log(`✓ ${bookAbbr}${chapter}:${verseRange} = ${result.substring(0, 30)}...`);
                return result;
            }
        } catch (err) {
            console.warn('Error fetching verse:', bookAbbr, chapter, verseRange, err);
            return null;
        }
    }
    
    // Add verse references to content (now works for all days since content is normalized)
    async function enhanceVerseReferences() {
        const contentEl = document.getElementById('devotional-content');
        if (!contentEl) return;
        
        // Pattern to match verse references with optional prefix
        // Use explicit list of valid book abbreviations
        const bookNames = '创|出|利|民|申|书|士|得|撒上|撒下|王上|王下|代上|代下|拉|尼|斯|伯|诗|箴|传|歌|赛|耶|哀|结|但|何|珥|摩|俄|拿|弥|鸿|哈|番|该|亚|玛|太|可|路|约|徒|罗|林前|林后|加|弗|腓|西|帖前|帖后|提前|提后|多|门|来|雅|彼前|彼后|约一|约二|约三|犹|启';
        const pattern = new RegExp(`([（(]?参)?(${bookNames})(\\d+):(\\d+(?:-\\d+)?)`, 'g');
        
        const matches = [];
        let match;
        const originalHTML = contentEl.innerHTML;
        
        // Skip if already processed (has verse-ref spans)
        if (originalHTML.includes('class="verse-ref"')) {
            console.log('Verses already enhanced, skipping');
            return;
        }
        
        while ((match = pattern.exec(originalHTML)) !== null) {
            const prefix = match[1] || '';
            const book = match[2];
            const chapter = match[3];
            const verse = match[4];
            const ref = `${book}${chapter}:${verse}`;
            
            matches.push({
                index: match.index,
                length: match[0].length,
                fullMatch: match[0],
                prefix: prefix,
                ref: ref,
                book: book,
                chapter: chapter,
                verse: verse
            });
        }
        
        console.log(`Found ${matches.length} verse references`);
        
        // Fetch verse text for all unique references
        const verseTexts = new Map();
        for (const m of matches) {
            if (!verseTexts.has(m.ref)) {
                const verseText = await getVerseText(m.book, m.chapter, m.verse);
                if (verseText) {
                    verseTexts.set(m.ref, verseText);
                }
            }
        }
        
        console.log(`Fetched ${verseTexts.size} unique verses`);
        
        // Replace matches from end to start to avoid index shifting
        matches.sort((a, b) => b.index - a.index);
        
        let newHTML = originalHTML;
        for (const m of matches) {
            const verseText = verseTexts.get(m.ref);
            if (verseText) {
                const escapedVerse = verseText.replace(/"/g, '&quot;');
                const replacement = `${m.prefix}<span class="verse-ref" data-ref="${m.ref}" data-verse="${escapedVerse}">${m.ref}</span>`;
                
                // Replace by position (from end to start, so indices don't shift)
                newHTML = newHTML.substring(0, m.index) + replacement + newHTML.substring(m.index + m.length);
            }
        }
        
        contentEl.innerHTML = newHTML;
        
        // Add event listeners
        contentEl.querySelectorAll('.verse-ref').forEach(span => {
            span.addEventListener('mouseenter', showVerseTooltipFromData);
            span.addEventListener('mouseleave', hideVerseTooltip);
            span.addEventListener('touchstart', (e) => {
                e.preventDefault();
                showVerseTooltipFromData({target: e.target, clientX: e.touches[0].clientX, clientY: e.touches[0].clientY});
                setTimeout(hideVerseTooltip, 3000);
            });
        });
        
        console.log('Verse enhancement complete');
    }
    
    // Show tooltip using data attribute
    function showVerseTooltipFromData(event) {
        const ref = event.target.dataset.ref;
        const verseText = event.target.dataset.verse;
        
        console.log('Tooltip triggered:', ref, verseText ? 'has text' : 'no text');
        
        if (!verseText) return;
        
        const tooltip = createTooltip();
        tooltip.innerHTML = `<span class="verse-tooltip-ref">${ref}</span>${verseText}`;
        tooltip.classList.add('show');
        
        const x = event.clientX;
        const y = event.clientY;
        const tooltipRect = tooltip.getBoundingClientRect();
        
        let left = x + 10;
        let top = y + 10;
        
        if (left + tooltipRect.width > window.innerWidth) {
            left = x - tooltipRect.width - 10;
        }
        if (top + tooltipRect.height > window.innerHeight) {
            top = y - tooltipRect.height - 10;
        }
        
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
        
        console.log('Tooltip positioned at:', left, top);
    }

    // Load data from bibleData.json (generated by extractor). Falls back to a
    // friendly message if the file is missing or parsing fails.
    let bibleData = [];
    // Default current day is day 1 for fresh users (index 0). A saved value
    // in localStorage overrides this. (Previously we computed a default from
    // Jan 1 of the current year; keep that helper for advanced uses.)
    function computeDefaultDayIndex() {
        const now = new Date();
        // Jan 1 of current year
        const start = new Date(now.getFullYear(), 0, 1);
        const msPerDay = 24 * 60 * 60 * 1000;
        const diff = Math.floor((now.setHours(0,0,0,0) - start.setHours(0,0,0,0)) / msPerDay);
        return diff >= 0 ? diff : 0;
    }
    const saved = localStorage.getItem('savedDay');
    let currentDayIndex;
    if (saved !== null) {
        currentDayIndex = parseInt(saved, 10);
    } else {
        // New users start at day 1 (index 0). If you want the old behavior
        // (default based on Jan 1), replace the following line with
        // computeDefaultDayIndex().
        currentDayIndex = 0;
    }

    // Get or set the start date for the reading plan
    // First-time visitors: current date becomes Day 1 Week 1
    function getStartDate() {
        let startDateStr = localStorage.getItem('readingPlanStartDate');
        if (!startDateStr) {
            // First time visitor - use today as Day 1
            const today = new Date();
            startDateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            localStorage.setItem('readingPlanStartDate', startDateStr);
        }
        const [year, month, day] = startDateStr.split('-').map(Number);
        return new Date(year, month - 1, day);
    }

    const PLAN_START_DATE = getStartDate();
    
    // Chapter index for Bible chapter navigation
    const chapterIndex = [];
    
    // Get canonical Bible book order (1-66)
    function getBookOrder(abbr) {
        const bookOrder = {
            // Old Testament (1-39)
            '创': 1, '出': 2, '利': 3, '民': 4, '申': 5,
            '书': 6, '士': 7, '得': 8, '撒上': 9, '撒下': 10,
            '王上': 11, '王下': 12, '代上': 13, '代下': 14, '拉': 15,
            '尼': 16, '斯': 17, '伯': 18, '诗': 19, '箴': 20,
            '传': 21, '歌': 22, '赛': 23, '耶': 24, '哀': 25,
            '结': 26, '但': 27, '何': 28, '珥': 29, '摩': 30,
            '俄': 31, '拿': 32, '弥': 33, '鸿': 34, '哈': 35,
            '番': 36, '该': 37, '亚': 38, '玛': 39,
            // New Testament (40-66)
            '太': 40, '可': 41, '路': 42, '约': 43, '徒': 44,
            '罗': 45, '林前': 46, '林后': 47, '加': 48, '弗': 49,
            '腓': 50, '西': 51, '帖前': 52, '帖后': 53, '提前': 54,
            '提后': 55, '多': 56, '门': 57, '来': 58, '雅': 59,
            '彼前': 60, '彼后': 61, '约一': 62, '约二': 63, '约三': 64,
            '犹': 65, '启': 66
        };
        return bookOrder[abbr] || 999;
    }
    
    // Map abbreviations to full book names
    function getFullBookName(abbr) {
        const bookNames = {
            '创': '创世记', '出': '出埃及记', '利': '利未记',
            '民': '民数记', '申': '申命记', '书': '约书亚记',
            '士': '士师记', '得': '路得记', '撒上': '撒母耳记上',
            '撒下': '撒母耳记下', '王上': '列王纪上', '王下': '列王纪下',
            '代上': '历代志上', '代下': '历代志下', '拉': '以斯拉记',
            '尼': '尼希米记', '斯': '以斯帖记', '伯': '约伯记',
            '诗': '诗篇', '箴': '箴言', '传': '传道书', '歌': '雅歌',
            '赛': '以赛亚书', '耶': '耶利米书', '哀': '耶利米哀歌',
            '结': '以西结书', '但': '但以理书', '何': '何西阿书',
            '珥': '约珥书', '摩': '阿摩司书', '俄': '俄巴底亚书',
            '拿': '约拿书', '弥': '弥迦书', '鸿': '那鸿书',
            '哈': '哈巴谷书', '番': '西番雅书', '该': '哈该书',
            '亚': '撒迦利亚书', '玛': '玛拉基书',
            '太': '马太福音', '可': '马可福音', '路': '路加福音',
            '约': '约翰福音', '徒': '使徒行传', '罗': '罗马书',
            '林前': '哥林多前书', '林后': '哥林多后书', '加': '加拉太书',
            '弗': '以弗所书', '腓': '腓立比书', '西': '歌罗西书',
            '帖前': '帖撒罗尼迦前书', '帖后': '帖撒罗尼迦后书',
            '提前': '提摩太前书', '提后': '提摩太后书', '多': '提多书',
            '门': '腓利门书', '来': '希伯来书', '雅': '雅各书',
            '彼前': '彼得前书', '彼后': '彼得后书', '约一': '约翰一书',
            '约二': '约翰二书', '约三': '约翰三书', '犹': '犹大书',
            '启': '启示录'
        };
        return bookNames[abbr] || abbr;
    }
    
    // Build chapter index from data
    function buildChapterIndex() {
        if (!bibleData || bibleData.length === 0) return;
        
        bibleData.forEach((entry, idx) => {
            const scripture = entry.scripture || '';
            // Extract book name (everything before numbers/章/篇)
            const match = scripture.match(/^([^一二三四五六七八九十廿卅\d]+)/);
            if (match) {
                const book = match[1].trim();
                const chapterPart = scripture.substring(book.length).trim();
                
                chapterIndex.push({
                    index: idx,
                    book: book,
                    bookFull: getFullBookName(book),
                    bookOrder: getBookOrder(book),
                    chapterPart: chapterPart,
                    scripture: scripture,
                    dayLabel: entry.day_label
                });
            }
        });
        
        // Sort by book order
        chapterIndex.sort((a, b) => {
            if (a.bookOrder !== b.bookOrder) {
                return a.bookOrder - b.bookOrder;
            }
            return a.index - b.index;
        });
    }


    // DOM helpers to avoid runtime errors when an element is missing
    function el(id){ return document.getElementById(id); }
    function setText(id, txt){ const e = el(id); if(e) e.innerText = txt; else console.warn('Missing element:', id); }
    function setHTML(id, html){ const e = el(id); if(e) e.innerHTML = html; else console.warn('Missing element:', id); }
    function setDisabled(id, v){ const e = el(id); if(e) e.disabled = v; else console.warn('Missing element:', id); }


    // Populate chapter dropdown based on chapter index
    function populateChapterDropdown() {
        const chapterSelect = document.getElementById('jump-chapter');
        if (!chapterSelect || chapterIndex.length === 0) return;
        
        chapterSelect.innerHTML = '<option value="">选择章节...</option>';
        
        chapterIndex.forEach(item => {
            const option = document.createElement('option');
            option.value = item.index;
            option.textContent = `${item.bookFull} ${item.chapterPart}`;
            chapterSelect.appendChild(option);
        });
    }

    // Wire up chapter selector after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        const jchapter = document.getElementById('jump-chapter');
        
        // Chapter selector: jump and reset
        if (jchapter) {
            jchapter.addEventListener('change', () => {
                const idx = parseInt(jchapter.value, 10);
                if (!isNaN(idx) && idx >= 0) {
                    currentDayIndex = idx;
                    localStorage.setItem('savedDay', currentDayIndex);
                    renderDay();
                    // Reset chapter selector for next use
                    jchapter.value = '';
                }
            });
        }
    });

    function renderDay() {
        try {
        if (!bibleData || bibleData.length === 0) {
            setText('day-title', '未找到数据');
            setText('devotional-content', '请先运行提取器生成 bibleData.json，然后刷新页面。');

            setText('scripture', '');
            setText('key-verse', '');
            setDisabled('prev-btn', true);
            setDisabled('next-btn', true);
            return;
        }

        // clamp index
        if (currentDayIndex < 0) currentDayIndex = 0;
        if (currentDayIndex >= bibleData.length) currentDayIndex = bibleData.length - 1;

        const data = bibleData[currentDayIndex];
        
        // Display week and day number for debugging
        const weekNum = Math.floor(currentDayIndex / 6) + 1;
        const dayNum = (currentDayIndex % 6) + 1;
        setText('week-day-info', `第${weekNum}周 第${dayNum}日 (索引: ${currentDayIndex})`);
        
        setText('scripture', data.scripture || '');
        setText('day-title', data.title || '');

        // allow HTML in content if present (tables, lists, paragraphs), otherwise plain text
        const contentEl = el('devotional-content');
        if (contentEl) {
            // Check for common HTML tags to decide whether to render as HTML
            if (data.content && /\<\/?(table|tr|td|th|div|p|ol|ul|li|dl|dt|dd|blockquote|br|b|i|strong|em|h[1-6])/i.test(data.content)) {
                contentEl.innerHTML = data.content;
            } else {
                contentEl.innerText = data.content || '';
            }
        } else {
            console.warn('Missing element: devotional-content');
        }

        // Display verse text if available, otherwise just show the reference
        const verseEl = el('key-verse');
        if (verseEl) {
            if (data.verse_parts && data.verse_parts.length > 0) {
                // Display each verse part with its individual reference
                const partsHtml = data.verse_parts.map(part => 
                    `<div style="margin-bottom: 12px;"><strong>${part.reference}</strong><br>${part.text}</div>`
                ).join('');
                verseEl.innerHTML = partsHtml;
            } else if (data.verse_text) {
                verseEl.innerText = `${data.verse}\n\n${data.verse_text}`;
            } else {
                verseEl.innerText = data.verse || '';
            }
        }

        setDisabled('prev-btn', currentDayIndex === 0);
        setDisabled('next-btn', currentDayIndex === bibleData.length - 1);
        } catch (err) {
            console.error('renderDay failed:', err);
            // diagnostic: list key elements and their presence
            const ids = ['date-display','day-num-text','day-date','scripture','day-title','devotional-content','reflection','key-verse','prev-btn','next-btn'];
            ids.forEach(id => console.warn(id, !!document.getElementById(id)));
        }

        localStorage.setItem('savedDay', currentDayIndex);
        window.scrollTo(0,0);
        
        // Add verse tooltips for Week 1 Day 1
        setTimeout(enhanceVerseReferences, 100);
    }

    function changeDay(step) {
        // For 6-day reading plan: data indices are continuous (0,1,2,3,4,5,6,7...)
        // but calendar dates skip every 7th day (Jan 1,2,3,4,5,6,8,9,10,11,12,13,15...)
        // So we just increment/decrement the data index normally
        currentDayIndex += step;
        renderDay();
    }

    // Fetch bibleData.json from the same directory
    fetch('bibleData.json', { cache: 'no-store' })
        .then(r => {
            if (!r.ok) throw new Error('网络错误：' + r.status);
            return r.json();
        })
        .then(json => {
            // some extractors put the days array at the top-level; accept either
            // an array or an object with a top-level array.
            if (Array.isArray(json)) bibleData = json;
            else if (Array.isArray(json.data)) bibleData = json.data;
            else bibleData = json;
            
            buildChapterIndex();
            populateChapterDropdown();
            renderDay();
        })
        .catch(err => {
            console.warn('无法加载 bibleData.json:', err);
            bibleData = [];
            renderDay();
        });

    // 注册 Service Worker
    if ('serviceWorker' in navigator) {
        // version string appended to service worker URL to force reload when we change the file
        const APP_SW_VERSION = 'v9';
        window.addEventListener('load', () => {
            navigator.serviceWorker.register(`sw.js?${APP_SW_VERSION}`)
              .then(reg => console.log('sw registered:', reg.scope))
              .catch(err => console.warn('sw registration failed:', err));
        });
    }
</script>
</body>
</html>