<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>每天与主同行</title>
    <!-- versioned manifest to bust cache when we update the app -->
    <link rel="manifest" href="manifest.json?v=3">
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icons/icon.svg">
    
    <style>
        :root { --primary: #4A90E2; --bg: #f5f7fa; --text: #333; }
        body { font-family: -apple-system, "PingFang SC", "Helvetica Neue", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        header { background: var(--primary); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; line-height: 1.8; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .scripture-ref { font-weight: bold; color: var(--primary); font-size: 1.1em; display: block; margin-bottom: 10px; }
        h2 { margin: 0 0 15px 0; font-size: 1.4em; }
        .section-title { font-weight: bold; border-left: 4px solid var(--primary); padding-left: 10px; margin: 25px 0 10px 0; }
        .verse-box { background: #eef5ff; border-radius: 8px; padding: 15px; font-style: italic; color: #444; margin-top: 20px; border: 1px dashed var(--primary); }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        button { border: none; background: var(--primary); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; cursor: pointer; transition: opacity 0.2s; }
        button:disabled { background: #ccc; }
        .day-indicator { color: var(--text); line-height: 36px; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <div id="date-display" style="font-size: 0.8em; opacity: 0.8;">第一周</div>
    <h1 id="app-title"   style="margin: 5px 0; font-size: 1.2em;">每天与主同行</h1>
    <div style="margin-top:8px; display:flex; justify-content:center; gap:8px;">
        <input id="jump-date" type="date" aria-label="跳转到日期" style="padding:6px 8px; border-radius:6px; border: none; max-width:150px;" />
        <button id="jump-btn" style="padding:6px 10px; border-radius:6px;">跳转</button>
    </div>
</header>

<div class="container">
    <div class="card" id="content-card">
        <span class="scripture-ref" id="scripture"></span>
        <h2 id="day-title">载入中...</h2>
        <div id="devotional-content"></div>
        
        <div class="section-title">反思问题</div>
        <div id="reflection"></div>
        
        <div class="verse-box">
            <strong>今日金句：</strong><br>
            <span id="key-verse"></span>
        </div>
    </div>
</div>

    <div class="nav-bar">
    <button onclick="changeDay(-1)" id="prev-btn">前一天</button>
    <div class="day-indicator" id="day-num">
        <div id="day-num-text">第 1 天</div>
        <div id="day-date" style="font-size:0.8em; opacity:0.9;">一月一日</div>
    </div>
    <button onclick="changeDay(1)" id="next-btn">后一天</button>
</div>

<script>
    // Load data from bibleData.json (generated by extractor). Falls back to a
    // friendly message if the file is missing or parsing fails.
    let bibleData = [];
    // Default current day is computed from Jan 1 of the current year so that
    // users who start the plan on Jan 1 will see the appropriate day as the
    // year progresses. A saved value in localStorage overrides this.
    function computeDefaultDayIndex() {
        const now = new Date();
        // Jan 1 of current year
        const start = new Date(now.getFullYear(), 0, 1);
        const msPerDay = 24 * 60 * 60 * 1000;
        const diff = Math.floor((now.setHours(0,0,0,0) - start.setHours(0,0,0,0)) / msPerDay);
        return diff >= 0 ? diff : 0;
    }
    const saved = localStorage.getItem('savedDay');
    let currentDayIndex = saved !== null ? parseInt(saved, 10) : computeDefaultDayIndex();

    // helpers to render Chinese month/day like "一月一日"
    const CN_DIGITS = ['零','一','二','三','四','五','六','七','八','九'];
    function numToChinese(n){
        if(n <= 10) return n === 10 ? '十' : CN_DIGITS[n];
        if(n < 20) return '十' + (n % 10 === 0 ? '' : CN_DIGITS[n % 10]);
        const tens = Math.floor(n / 10);
        const ones = n % 10;
        return CN_DIGITS[tens] + '十' + (ones === 0 ? '' : CN_DIGITS[ones]);
    }
    function chineseMonthDayFromIndex(dayIndex){
        const yearStart = new Date(new Date().getFullYear(), 0, 1);
        const d = new Date(yearStart.getTime());
        d.setDate(d.getDate() + dayIndex);
        const month = d.getMonth() + 1;
        const day = d.getDate();
        return `${numToChinese(month)}月${numToChinese(day)}日`;
    }

    // return day index relative to Jan 1 of the given date's year
    function dateToDayIndex(dateObj){
        const start = new Date(dateObj.getFullYear(), 0, 1);
        const msPerDay = 24 * 60 * 60 * 1000;
        const diff = Math.floor((new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()).getTime() -
                                 new Date(start.getFullYear(), start.getMonth(), start.getDate()).getTime()) / msPerDay);
        return diff >= 0 ? diff : 0;
    }

    // format a dayIndex into YYYY-MM-DD in the current year (used to set the date input)
    function isoDateFromIndex(dayIndex){
        const year = new Date().getFullYear();
        const d = new Date(year, 0, 1);
        d.setDate(d.getDate() + dayIndex);
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${d.getFullYear()}-${mm}-${dd}`;
    }

    function setJumpInputToCurrent(){
        const el = document.getElementById('jump-date');
        if(!el) return;
        try{
            el.value = isoDateFromIndex(currentDayIndex);
        }catch(e){ /* ignore */ }
    }

    // DOM helpers to avoid runtime errors when an element is missing
    function el(id){ return document.getElementById(id); }
    function setText(id, txt){ const e = el(id); if(e) e.innerText = txt; else console.warn('Missing element:', id); }
    function setHTML(id, html){ const e = el(id); if(e) e.innerHTML = html; else console.warn('Missing element:', id); }
    function setDisabled(id, v){ const e = el(id); if(e) e.disabled = v; else console.warn('Missing element:', id); }

    // Jump handler: read the date input, compute index, clamp and navigate
    function handleJump(){
        const el = document.getElementById('jump-date');
        if(!el || !el.value) return;
        const parts = el.value.split('-');
        if(parts.length !== 3) return;
        const y = parseInt(parts[0],10), m = parseInt(parts[1],10)-1, d = parseInt(parts[2],10);
        const sel = new Date(y,m,d);
        let idx = dateToDayIndex(sel);
        // clamp to available data once loaded
        if(Array.isArray(bibleData) && bibleData.length > 0){
            if(idx < 0) idx = 0;
            if(idx >= bibleData.length) idx = bibleData.length - 1;
        }
        currentDayIndex = idx;
        localStorage.setItem('savedDay', currentDayIndex);
        renderDay();
    }

    // wire up jump controls after DOM is ready
    document.addEventListener('DOMContentLoaded', ()=>{
        const jb = document.getElementById('jump-btn');
        const jd = document.getElementById('jump-date');
        if(jb) jb.addEventListener('click', handleJump);
        if(jd) jd.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') handleJump(); });
    });

    function renderDay() {
        try {
        if (!bibleData || bibleData.length === 0) {
            setText('day-title', '未找到数据');
            setText('devotional-content', '请先运行提取器生成 bibleData.json，然后刷新页面。');
            setText('reflection', '');
            setText('scripture', '');
            setText('key-verse', '');
            setDisabled('prev-btn', true);
            setDisabled('next-btn', true);
            return;
        }

        // clamp index
        if (currentDayIndex < 0) currentDayIndex = 0;
        if (currentDayIndex >= bibleData.length) currentDayIndex = bibleData.length - 1;

        const data = bibleData[currentDayIndex];
        // day label
        const dayLabel = `第 ${data.day || (currentDayIndex+1)} 天`;
        const dayDateLabel = chineseMonthDayFromIndex(currentDayIndex);
        setText('day-num-text', dayLabel);
        setText('day-date', dayDateLabel);
        // Show week number calculated from the current day assuming week = 7 days
        const weekNum = Math.floor(currentDayIndex / 7) + 1;
        setText('date-display', `第 ${weekNum} 周`);
        setText('scripture', data.scripture || '');
        setText('day-title', data.title || '');

        // allow HTML in content if present (tables), otherwise plain text
        const contentEl = el('devotional-content');
        if (contentEl) {
            if (data.content && /<\/?(table|tr|td|th|div|p)/i.test(data.content)) {
                contentEl.innerHTML = data.content;
            } else {
                contentEl.innerText = data.content || '';
            }
        } else {
            console.warn('Missing element: devotional-content');
        }

        setText('reflection', data.reflection || '');
        setText('key-verse', data.verse || '');

        setDisabled('prev-btn', currentDayIndex === 0);
        setDisabled('next-btn', currentDayIndex === bibleData.length - 1);
        } catch (err) {
            console.error('renderDay failed:', err);
            // diagnostic: list key elements and their presence
            const ids = ['date-display','day-num-text','day-date','scripture','day-title','devotional-content','reflection','key-verse','prev-btn','next-btn'];
            ids.forEach(id => console.warn(id, !!document.getElementById(id)));
        }

        localStorage.setItem('savedDay', currentDayIndex);
        window.scrollTo(0,0);
        // keep the date input in sync with the currently shown day
        setJumpInputToCurrent();
    }

    function changeDay(step) {
        currentDayIndex += step;
        renderDay();
    }

    // Fetch bibleData.json from the same directory
    fetch('bibleData.json', { cache: 'no-store' })
        .then(r => {
            if (!r.ok) throw new Error('网络错误：' + r.status);
            return r.json();
        })
        .then(json => {
            // some extractors put the days array at the top-level; accept either
            // an array or an object with a top-level array.
            if (Array.isArray(json)) bibleData = json;
            else if (Array.isArray(json.data)) bibleData = json.data;
            else bibleData = json;
            renderDay();
        })
        .catch(err => {
            console.warn('无法加载 bibleData.json:', err);
            bibleData = [];
            renderDay();
        });

    // 注册 Service Worker
    if ('serviceWorker' in navigator) {
        // version string appended to service worker URL to force reload when we change the file
        const APP_SW_VERSION = 'v3';
        window.addEventListener('load', () => {
            navigator.serviceWorker.register(`sw.js?${APP_SW_VERSION}`)
              .then(reg => console.log('sw registered:', reg.scope))
              .catch(err => console.warn('sw registration failed:', err));
        });
    }
</script>
</body>
</html>